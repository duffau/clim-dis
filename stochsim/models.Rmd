---
title: "Dynamic models and their simulation by Euler's method"
author: "Edward Ionides"
date: "07/13/2015"
output:
  html_document:
    theme: flatly
    toc: yes
bibliography: models.bib
csl: ecology.csl

---

Licensed under the Creative Commons attribution-noncommercial license, http://creativecommons.org/licenses/by-nc/3.0/.
Please share and remix noncommercially, mentioning its origin.  
![CC-BY_NC](http://dept.stat.lsa.umich.edu/~ionides/tutorials/cc-by-nc.png)

```{r opts,include=FALSE}
library(pomp)
library(knitr)
prefix <- "mif"
opts_chunk$set(
  progress=TRUE,
  prompt=FALSE,tidy=FALSE,highlight=TRUE,
  strip.white=TRUE,
  warning=FALSE,
  message=FALSE,
  error=FALSE,
  echo=TRUE,
  cache=TRUE,
  results='markup',
  fig.show='asis',
  size='small',
  fig.lp="fig:",
  fig.path=paste0("figure/",prefix,"-"),
  cache.path=paste0("cache/",prefix,"-"),
  fig.pos="h!",
  fig.align='center',
  fig.height=4,fig.width=6.83,
  dpi=300,
  dev='png',
  dev.args=list(bg='transparent')
  )

options(
  pomp.cache="cache",
  keep.source=TRUE,
  encoding="UTF-8"
  )

library(ggplot2)
theme_set(theme_bw())
```


## Objectives

This tutorial develops some classes of dynamic models relevant for biological systems, with particular reference to epidemiology. It is preparation for a [series of tutorials](http://dept.stat.lsa.umich.edu/~ionides/tutorials/index.html) on time series analysis using mechanistic modeling. We have the following goals:

1. Dynamic systems can often be represented in terms of _flows_ between _compartments_. We will develop the concept of a _compartment model_ for which we specify _rates_ for the flows between compartments.

2. We develop deterministic and stochastic interpretations of a compartment model.

3. We introduce Euler's method to simulate from dynamic models, and we apply it to both deterministic and stochastic compartment models.

## Introduction

We will develop deterministic and stochastic representations of a susceptible-infected-recovered (SIR) system, a fundamental class of models for disease transmission dynamics. We will do this using notation which generalizes to more complex systems [[@breto09]](http://dept.stat.lsa.umich.edu/~ionides/pubs/breto09.pdf).

```{r sir-diagram,echo=FALSE,cache=FALSE}
require(DiagrammeR)
DiagrammeR("graph LR; S(S) --> I; I(I) --> R(R);"
           ,height=200,width=500)
```
$S = \text{susceptible}$  
$I = \text{infected and infectious}$  
$R = \text{recovered and/or removed}$  

* We suppose that each arrow has an associated rate, so here there is a rate $\mu_{SI}(t)$ at which individuals in $S$ transition to $I$, and $\mu_{IR}$ at which individuals in $I$ transition to $R$. 

* To account for demography (births/deaths/immigration/emmigration) we allow the possibility of a source and sink compartment, which is not usually represented on the flow diagram. We write $\mu_{{\small\bullet} S}$ for a rate of births into $S$, and denote mortality rates by $\mu_{S{\small\bullet}}$, $\mu_{I{\small\bullet}}$, $\mu_{R{\small\bullet}}$.

* The rates may be either constant or varying. In particular, for a simple SIR model, the recovery rate $\mu_{IR}$ is a constant but the infection rate has the time-varying form
$$\mu_{SI}(t)=\beta \, I(t),$$
with $\beta$ being the _contact rate_. Now, for the simplest SIR model, ignoring demography, we set
$$ \mu_{{\small\bullet} S}=\mu_{S{\small\bullet}}=\mu_{I{\small\bullet}}=\mu_{R{\small\bullet}}=0.$$

* To develop a systemtic notation, it turns out to be convenient to keep track of the flows between compartments as well as the number of individuals in each compartment. Let
$$N_{SI}(t)$$
count the number of individuals who have transitioned from $S$ to $I$ by time $t$. We say that $N_{SI}(t)$ is a _counting process_. A similarly constructed process
$$N_{IR}(t)$$
counts individuals transitioning from $I$ to $R$. To include demography, we could keep track of birth and death events by the counting processes $N_{{\small\bullet} S}(t)$, $N_{S{\small\bullet}}(t)$, $N_{I{\small\bullet}}(t)$, $N_{R{\small\bullet}}(t)$.

* For discrete population compartment models, the flow counting processes are non-decreasing and integer valued.

* For continuous population compartment models, the flow counting processes are non-decreasing and real valued.

* The numbers of people in each compartment can be computed via these counting processes. Ignoring demography, we have:
$$ S(t)= S(0) - N_{SI}(t)$$
$$ I(t)= I(0) + N_{SI}(t) - N_{IR}(t)$$
$$ R(t) = R(0) + N_{IR}(t)$$

* These equations represent something like _conservation of mass_, or _what goes in must come out_. 

### The _ordinary differential equation_ (ODE) interpretation of the SIR model

Together with initial conditions specifying $S(0)$, $I(0)$ and $R(0)$, we just need to write down ODEs for the flow counting processes. These are,
$$ dN_{SI}/dt = \mu_{SI}(t) \, S(t),$$
$$ dN_{IR}/dt = \mu_{IR}\, I(t).$$

### The simple continuous-time Markov chain interpretation of the SIR model

* Continuous-time Markov chains are the basic tool for building discrete population epidemic models.

* Recall that a _Markov chain_ is a discrete-valued stochastic process with the _Markov property_:  the future evolution of the process depends only on the current state.

* Surprisingly many models have this Markov property. If all important variables are included in the state of the system, then the Markov property appears automatically.

* The Markov property lets us specify a model by the transition probabilities on small intervals (together with the initial conditions). For the SIR model, we have
$$P[N_{SI}(t+\delta)=N_{SI}(t)+1] = \mu_{SI}(t) \, S(t) \delta + o(\delta)$$
$$P[N_{SI}(t+\delta)=N_{SI}(t)] = 1-\mu_{SI}(t) \, S(t) \delta + o(\delta)$$
$$P[N_{IR}(t+\delta)=N_{IR}(t)+1] = \mu_{IR} \, I(t) \delta + o(\delta)$$
$$P[N_{IR}(t+\delta)=N_{IR}(t)] = 1-\mu_{IR}(t) \, I(t) \delta + o(\delta)$$



#### Exercise: find the expected value of $N_{SI}(t+\delta)-N_{SI}(t)$ and $N_{IR}(t+\delta)-N_{IR}(t)$ given the current state, $S(t)$, $I(t)$ and $R(t)$. Take the limit as $\delta\to 0$ and show that this gives the ODE model.


* A _simple_ counting process is one which cannot count more than one event at a time ([Wikipedia: Point_process](https://en.wikipedia.org/wiki/Point_process)). Thus, in a technical sense, the SIR Markov chain model we have written is simple. One may want to model the extra randomness resulting from multiple simultaneous events: someone sneezing in a bus; large gatherings at football matches; etc. This extra randomness may even be critical to match the variability in data. 
* We will see later, in the [measles case study](../measles/measles.html), a situation where this extra randomness plays an important role. Setting up the model using counting processes, as we have done here, turns out to be useful for this.



## Euler's method for ordinary differential equations (ODEs)

* [Euler](https://en.wikipedia.org/wiki/Leonhard_Euler) took the following approach to numeric solution of an ODE:
    + He wanted investigate an ODE
$$dx/dt = h(x)$$
with an initial condition $x(0)$. He supposed this ODE has some true solution $x(t)$ which could not be worked out analytically. He therefore wished to approximate $x(t)$ numerically.
    + He initialized the numerical solution at the known starting value, 
$$\tilde x(0)=x(0).$$
Then, for $k=1,2,\dots$, he supposed that the gradient $dx/dt$ is approximately constant over the small time interval $k\delta\le t\le (k+1)\delta$. Therefore, he defined
$$\tilde x\big( \,(k+1)\delta\,\big) = \tilde x( k\delta) + \delta \, h\big(\, \tilde x(k\delta)\,\big).$$
   + This only defines $\tilde x(t)$ when $t$ is a multiple of $\delta$, but let's suppose $\tilde x(t)$ is constant between these discrete times.

* We now have a numerical scheme, stepping forwards in time increments of size $\delta$, that can be readily evaluated by computer (or by hand, if you are Euler). 

* [Mathematical analysis of Euler's method](https://en.wikipedia.org/wiki/Euler_method) says that, as long as the function $h(x)$ is not too exotic, then $x(t)$ is well approximated by $\tilde x(t)$  when the discretization time-step, $\delta$, is sufficiently small.

* Euler's method is not the only numerical scheme to solve ODEs. More advanced schemes have better convergence properties, meaning that the numerical approximation is closer to $x(t)$. However, there are 3 reasons we choose to lean heavily on Euler's method:

1. Euler's method is the simplest (following the KISS principle).

2. Euler's method extends naturally to stochastic models, both continuous-time Markov chains models and stochastic differential equation (SDE) models.

3. Close approximation of the numerical solutions to a continuous-time model is less important than it may at first appear, a topic worth further discussion...

## Some comments on using continuous-time models and discretized approximations

* In some physical and engineering situations, a system follows an ODE model closely. For example, Newton's laws provide a very good approximation to the motions of celestial bodies. 

* In many biological situations, ODE models only become close mathematical approximations to reality at reasonably large scale. On small temporal scales, models cannot usually capture the full scope of biological variation and biological complexity. 

* If we are going to expect substantial error in using $x(t)$ to model a biological system, maybe the numerical solution $\tilde x(t)$ represents the system being modeled as well as $x(t)$  does.

* If our model fitting, model investigation, and final conclusions are all based on our numerical solution  $\tilde x(t)$ (i.e., we are sticking entirely to simulation-based methods) then we are most immediately concerned with how well  $\tilde x(t)$ describes the system of interest.  $\tilde x(t)$ becomes more important than the original model, $x(t)$.

* When following this perspective, it is important that the scientists fully describe the numerical model $\tilde x(t)$. 
The main advantage of the continuous-time model $x(t)$ is then that it gives a succinct way to describe how $\tilde x(t)$ was constructed.

* All numerical methods are, ultimately, discretizations. Epidemiologically, setting $\delta$ to be a day, or an hour, can be quite different from setting $\delta$ to be two weeks or a month. For continuous-time modeling, we still require that $\delta$ is small compared to the timescale of the process being modeled, and the choice of $\delta$ does not play an explicit role in the interpretation of the model.

* Putting more emphasis on the scientific role of the numerical solution itself reminds you that the numerical solution has to do more than approximate a target model in some asymptotic sense: the numerical solution should be a sensible model in its own right. 

## Euler's method for a discrete SIR model

* Recall the simple continuous-time Markov chain interpretation of the SIR model without demography:
$$P[N_{SI}(t+\delta)=N_{SI}(t)+1] = \mu_{SI}(t) \, S(t) \delta + o(\delta),$$
$$P[N_{IR}(t+\delta)=N_{IR}(t)+1] = \mu_{IR} \, I(t) \delta + o(\delta).$$

* We look for a numerical solution with state variables $\tilde S(k\delta)$, $\tilde I(k\delta)$, $\tilde R(k\delta)$. 

* The counting processes for the flows between compartments are $\tilde N_{SI}(t)$ and $\tilde N_{IR}(t)$. The counting processes are related to the numbers of individuals in the compartments by the same flow equations we had before:
$$ \tilde S(k\delta)= S(0) - \tilde N_{SI}(k\delta)$$
$$ \tilde I(k\delta)= I(0) + \tilde N_{SI}(k\delta) - \tilde N_{IR}(k\delta)$$
$$ \tilde R(k\delta) = R(0) + \tilde N_{IR}(k\delta)$$

* Let's focus on a numerical solution to $N_{SI}(t)$, since the same methods can also be applied to $N_{IR}(t)$.

* Here are three possibilities:

<br>

1. $\quad \tilde N_{SI}\big( \,(k+1)\delta\,\big)= \tilde N_{SI}\big( k\delta \big) + \mathrm{Poisson}\big(\tilde \mu_{SI}(t) \, \tilde S(t) \,\delta\big)$, <br>
where $\mathrm{Poisson}(\mu)$ is a Poisson random variable with mean $\mu$ and 
$$\tilde \mu_{SI}(t) = \beta\, \tilde I(t).$$

<br>

2. $\quad \tilde N_{SI}\big( \,(k+1)\delta\,\big)= \tilde N_{SI}\big( k\delta \big) + \mathrm{Binomial}\big(\tilde S(t),\tilde \mu_{SI}(t) \, \delta\big)$, <br>
where $\mathrm{Binomial}(n,p)$ is a binomial random variable with mean $np$ and variance $np(1-p)$.

<br>

3. $\quad \tilde N_{SI}\big( \,(k+1)\delta\,\big)= \tilde N_{SI}\big( k\delta \big) + \mathrm{Binomial}\big(\tilde S(t),1-\exp\{-\tilde \mu_{SI}(t) \delta\}\big)$.

<br>
<br>


* What are the advantages of these different schemes? Conceptually, it is simplest to think of (1.) or (2.). Numerically, it is usually preferable to implement (3.). 


## Theoretical exercise: Compartment models via stochastic differential equations (SDEs)

The Euler method extends naturally to stochastic differential equations. A natural way to add stochastic variation to an ODE $dx/dt=h(x)$ is
$$ dX/dt = h(X) + \sigma \, dB/dt$$
where $\{B(t)\}$ is Brownian motion and so $dB/dt$ is Brownian noise. Then, an Euler approximation $\tilde X(t)$ is generated by 
$$ \tilde X\big( \,(k+1)\delta\,\big) = \tilde X( k\delta) + \delta\, h\big(\, \tilde X(k\delta)\,\big) + \sigma \sqrt{\delta} \, Z_k$$
where $Z_1,Z_2,\dots$ is a sequence of independent standard normal random variables, i.e.,  $Z_k\sim N[0,1]$. Although SDEs are often considered an advanced topic in probability, the Euler approximation doesn't demand much more than familiarity with the normal distribution.

Write down a stochastic Euler method for an SDE representation of the SIR model. Consider some difficulties that might arise with non-negativity constraints, and propose some practical way one might deal with that issue.

* A useful method to deal with positivity constraints is to use Gamma noise rather than Brownian noise [@bhadra11,@laneri10]. SDEs driven by Gamma noise can be investigated by Euler solutions simply by replacing the Gaussian noise by an appropriate Gamma distribution.

## Conceptual exercise: Euler's method vs Gillspie's algorithm

* A widely used, exact simulation method for continuous time Markov chains is [Gillspie's algorithm](https://en.wikipedia.org/wiki/Gillespie_algorithm
). We do not put much emphasis on Gillespie's algorithm here. Why? When would you prefer an implementation of Gillespie's algorithm to an Euler solution?

* Numerically, Gillespie's algorithm is often approximated using so-called [tau-leaping](https://en.wikipedia.org/wiki/Tau-leaping) methods. These are closely related to Euler's approach. Is it reasonable to call a suitable Euler approach a tau-leaping method?


----------------------


## References





